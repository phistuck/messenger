<!doctype html>
<html>
 <head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge; chrome=1"/>
  <title>Login</title>
  <style>
   .desktop H1 { display: none; }
   
   body { background: ThreeDFace; font: normal 13px Arial; text-align: center; color: #303030; }
   form .form-content, form .error-content, form .success-content { display: none; }
   form.success-mode .success-content,
   form.form-mode .form-content,
   form.error-mode .error-content { display: block; }
  </style>
 </head>
 <body>
  <h1>Messenger</h1>
  <form name="login" class="form-mode">
   <div class="error-content">
    There is a problem with the service. Please, try again later.<br/><br/>
    <a id="back" href="#">&lt;&lt; Back</a>
   </div>
   <div class="success-content">
    <b>Loading...</b>
   </div>
   <div class="form-content">
    <div>Welcome!<br/>Please, sign in first.</div>
    <br/><br/>
    <label>Username<br/>
    <input autocomplete="off" type="text" name="from" size="10"/></label><br/><br/>
    <a id="sign-in" href="/">Sign in</a>
   </div>
  </form>
  <script>
   /*jslint sloppy: true, white: true, browser: true*/
   /*global escape, unescape*/
   var form,
       desktop = document.location.href.indexOf("desktop=1") !== -1? "&desktop=1": "",
       dev = document.location.href.indexOf("dev=1") !== -1? "&dev=1": "";
   if (desktop)
   {
    document.documentElement.className += " desktop";
   }
   function login(user)
   {
    var recipient;
    if (user === "foo")
    {
     recipient = "baz";
    }
    else if (user === "baz" || user === "Baz")
    {
     user = "baz";
     recipient = "foo";
    }
    if (!recipient)
    {
     form.className = "error-mode";
    }
    else
    {
     form.className = "success-mode";
     form.from.blur();
     if (window.localStorage)
     {
      localStorage.user = user;
     }
     else
     {
      document.cookie = "user=" + escape(user) + "; path=/; max-age=" + 3e7 + ";";
     }
     document.location.href = "/converse?from=" + user + "&to=" + recipient + desktop + dev;
    }
    return false;
   }
   function tryAutomaticLogin()
   {
    try
    {
     var cookie, cookies, user, i, length;
     if (window.localStorage && localStorage.user)
     {
      user = localStorage.user;
     }
     else if (document.cookie.indexOf("user=") !== -1)
     {
      cookies = document.cookie.split(/\s*;\s*/g);
      /*jslint plusplus: true*/
      for (i = 0, length = cookies.length; i < length; i++)
      {
      /*jslint plusplus: false*/
       cookie = cookies[i].split("&");
       if (cookie[0] === "user")
       {
        user = unescape(cookie[1]);
        break;
       }
      }
     }
     login(user);
    }
    catch (e)
    {
    }
   }
   
   (function ()
    {
     function initiateLogin()
     {
      setTimeout(
       function ()
       {
        login(form.from.value);
       },
       0);
     }
     form = document.forms[0];
     if (!desktop)
     {
      form.from.focus();
     }
     form.from.onkeypress =
      function (e)
      {
       if (!e)
       {
        e = window.event;
       }
       if (e.keyCode === 13)
       {
        initiateLogin();
        return false;
       }
      };
     document.getElementById("back").onclick =
      function submit()
      {
       form.className = "form-mode";
       return false;
      };
     document.getElementById("sign-in").onclick =
      function submit()
      {
       initiateLogin();
       return false;
      };
    }());
    if (desktop)
    {
     window.process =
      function (action)
      {
       if (action === "focus")
       {
        if (form.className == "form-mode")
        {
         form.from.focus();
        }
       }
      };
    }
  </script>
 </body>
</html>